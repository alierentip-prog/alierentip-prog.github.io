<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Veridium ‚Äî Echo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--fg:#e9eef5;--b:rgba(255,255,255,.16);--glass:rgba(255,255,255,.06);--bg:#0b1118}
  *{box-sizing:border-box}html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 Inter}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;position:sticky;top:0;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);z-index:5}
  .btn{border:1px solid var(--b);background:var(--glass);color:var(--fg);padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:800}
  .actions{display:flex;gap:8px}
  main{max-width:980px;margin:14px auto;padding:0 14px}
  form#new{display:flex;gap:8px;margin-bottom:16px}
  textarea{flex:1;padding:12px;border-radius:12px;border:1px solid var(--b);background:#0c1520;color:var(--fg);min-height:80px}
  .card{border:1px solid var(--b);background:var(--glass);border-radius:14px;padding:14px 12px;margin-bottom:12px}
  .meta{opacity:.7;font-size:14px;margin-bottom:6px}
  .row{display:flex;gap:8px;align-items:center;margin-top:8px}
  .like,.commentBtn{cursor:pointer}
  .comments{margin-top:8px;padding-left:10px;border-left:2px solid rgba(255,255,255,.1)}
  .guestOnly{display:inline}
  .userOnly{display:none}
</style>
</head>
<body>
<header>
  <a class="btn" href="index.html">‚Üê Ana sayfa</a>
  <div class="actions">
    <span class="guestOnly">
      <a class="btn" href="login.html">Giri≈ü Yap</a>
      <a class="btn" href="login.html#signup">√úye Ol</a>
    </span>
    <span class="userOnly">
      <span id="userEmail" class="btn" style="pointer-events:none"></span>
      <button id="logoutBtn" class="btn" type="button">√áƒ±kƒ±≈ü Yap</button>
    </span>
  </div>
</header>

<main>
  <form id="new">
    <textarea id="echoTxt" placeholder="Bir s√∂z bƒ±rak... (giri≈ü yapmadan da Anonim payla≈üabilirsin)"></textarea>
    <button class="btn" type="submit">Payla≈ü</button>
  </form>

  <div id="list"></div>
</main>

<script type="module" src="./firebase.js"></script>
<script type="module" src="./app.js"></script>
<script type="module">
  import { Echo, Auth } from "./app.js";

  const list = document.getElementById("list");
  const form = document.getElementById("new");
  const input= document.getElementById("echoTxt");

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const user = Auth.current();
    const author = user?.email || "Anonim";
    const text = input.value.trim();
    if(!text) return;
    await Echo.add({ text, author });
    input.value="";
  });

  // Listeyi canlƒ± oku
  Echo.list(render);

  function render(items){
    list.innerHTML = items.map(row=>{
      const id=row.id || row.ts; const likeCount=(row.likes||[]).length;
      return `
        <div class="card" data-id="${id}">
          <div class="meta"><strong>${row.author||"Anonim"}</strong></div>
          <div>${row.text.replace(/</g,"&lt;")}</div>
          <div class="row">
            <span class="like btn" data-like="${id}">‚ù§Ô∏è ${likeCount}</span>
            <span class="commentBtn btn" data-comment="${id}">üí¨ Yorum</span>
          </div>
          <div class="comments">
            ${(row.comments||[]).map(c=>`<div>‚Ä¢ <strong>${c.by}</strong>: ${c.text.replace(/</g,"&lt;")}</div>`).join("")}
          </div>
        </div>`;
    }).join("");
  }

  // Like & yorum
  document.addEventListener("click", async (e)=>{
    const lk = e.target.closest("[data-like]"); 
    if (lk){ await Echo.like(lk.getAttribute("data-like"), Auth.current()); return; }
    const cm = e.target.closest("[data-comment]");
    if (cm){
      const txt = prompt("Yorum yaz:");
      if (txt) await Echo.comment(cm.getAttribute("data-comment"), Auth.current(), txt);
    }
  });
</script>
</body>
</html>
